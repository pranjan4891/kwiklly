<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kwiklly</title>

    <!-- CSS Links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
    <link rel="stylesheet" href="{{ asset('public/assets/website/CSS/style.css')}}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        /* Sidebar Styles */
        .change-link { padding: 15px; font-weight: bold; color: #ff4d4d; cursor: pointer; }
        .sidebar { position: fixed; top: 0; right: -100%; width: 100%; max-width: 520px; height: 100%; background: #fff; box-shadow: -3px 0 8px rgba(0, 0, 0, 0.15); z-index: 999999; transition: right 0.3s ease-in-out; border-left: 1px solid #ccc; }
        .sidebar.open { right: 0; }
        .sidebar-header { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #e0e0e0; font-size: 18px; font-weight: bold; }
        .sidebar-header i { margin-right: 10px; font-size: 20px; cursor: pointer; }
        .add-new-address { text-align: center; color: red; font-weight: 600; padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .address-section { padding: 16px; padding-bottom:45px; }
        .section-title { font-size: 14px; color: #666; margin-bottom: 12px; }
        .address-card { display: flex; align-items: flex-start; background: #fff; border: 1px solid #eee; border-radius: 6px; padding: 12px; margin-bottom: 12px; position: relative; }
        .address-card.active { background: #f3fff3; border-color: #c1eac5; }
        .icon { margin-right: 10px; font-size: 20px; margin-top: 3px; }
        .address-content { flex: 1; font-size: 14px; line-height: 1.4; color: #333; }
        .address-content b { display: block; margin-bottom: 4px; }
        .tick-icon { font-size: 16px; color: green; margin-left: 8px; margin-top: 2px; }
        .menu-icon { position: absolute; right: 12px; top: 16px; font-size: 18px; color: #999; cursor: pointer; }

        /* Cart Styles */
        .cart-sidebar { width: fit-content; height: 100vh; z-index: 1050; overflow-y: auto; transition: all 0.3s; }
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .proceed-btn { background: #4CAF50; color: white; padding: 15px; text-align: center; font-weight: bold; cursor: pointer; }

        /* Responsive */
        @media (max-width: 480px) {
            .sidebar { max-width: 100%; }
            .cart-sidebar { width: 100%; }
        }
        /* Initially hidden */
        #addpopOverlay, #addpopPopup {
            display: none;
        }

        /* Show overlay */
        .addpop-visible {
            display: block;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 1000;
        }

        /* Show popup for desktop */
        .addpop-desktop-active {
            display: block;
            position: absolute;
            z-index: 1001;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        /* Show popup for mobile */
        .addpop-mobile-active {
            display: block;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #fff;
            z-index: 1001;
            padding: 20px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
        }
        .location-box {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 100%;
        }

        .locations-text {
            font-size: 14px;
            line-height: 1.2;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (min-width: 640px) {
            .location-box {
                width: auto;
            }

            .locations-text {
                font-size: 16px;
                max-width: none;
                white-space: normal;
            }
        }

        /* Default hidden */
        #addpopPopup {
        display: none;
        }

        /* Show on mobile */
        .addpop-mobile-active {
        display: block;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #fff;
        z-index: 1001;
        padding: 20px;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
        }

        /* Show on desktop */
        .addpop-desktop-active {
        display: block;
        position: absolute;
        background: #fff;
        z-index: 1001;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        /* Overlay */
        .addpop-visible {
        display: block;
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.3);
        z-index: 1000;
        }

        /* Search input */
        .addpop-search-input {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        margin-top: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        }

    </style>
</head>
<body>

<!-- ==================== NAVBAR SECTION ==================== -->
<nav class="navbar navbar-expand-lg fixed-top">
    <div class="container-fluid">
        <!-- Desktop: Logo + Location & Search -->
        <div class="d-flex align-items-center w-100 d-none d-md-flex">
            <a class="navbar-brand" href="{{url('/')}}">
                <img src="{{ asset('public/assets/website/images/logo.png')}}" alt="Logo">
            </a>
            <div class="location-box" onclick="toggleAddpop(event)">
                <i class="fas fa-map-marker-alt"></i>
                <span class="location-text" id="currentLocation">Current Location <br>Fetching...</span>
                <i class="fas fa-chevron-down dropdown-icon"></i>
            </div>

            <!-- Search Box -->
            <div class="search-container ms-3">
                <input type="text" class="form-control search-box" placeholder='Search "Banana"' />
                <button class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <!-- Desktop Menu -->
        <div class="d-flex align-items-center desktop-menu">
            <a href="{{ route('department')}}">Department</a>
            <a href="{{ route('stores')}}">Store</a>
            @if(auth()->check())
            <a href="{{ route('customer.dashboard') }}">{{ auth()->user()->name }}</a>
            @else
                <a href="{{ route('login') }}">Join&nbsp;Us</a>
            @endif
            <button class="cart-btn d-none d-md-flex" id="openCart">
                <i class="fa fa-shopping-cart"></i>
                Cart (<span id="cart-count">{{ session('cart') ? count(session('cart')) : 0 }}</span>)
            </button>
        </div>

        <!-- Mobile: Location and Cart -->
        <div class="mobile-top d-md-none">
            <div class="location-box flex items-center space-x-2 p-3 rounded-md bg-white shadow-md w-full sm:w-auto" onclick="toggleAddpop(event)">
                <i class="fas fa-map-marker-alt text-red-500 text-lg"></i>
                <span class="locations-text text-sm sm:text-base leading-tight max-w-[200px] sm:max-w-none truncate">
                    Current Location <br>
                    <span id="currentLocation">Fetching location...</span>
                </span>
                <i class="fas fa-chevron-down dropdown-icon text-gray-600 text-sm"></i>
            </div>

            <button class="cart-btn" id="openCart2">
                <i class="fas fa-shopping-cart"></i>(4)
            </button>
        </div>

        <!-- Mobile Search -->
        <div class="search-container d-md-none">
            <input type="text" class="form-control search-box" placeholder='Search "Banana"' />
            <button class="search-btn">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
</nav>

<!-- Location Popup Overlay -->
<div class="addpop-overlay" id="addpopOverlay" onclick="closeAddpop()"></div>
<div class="addpop-popup" id="addpopPopup">
  <button class="addpop-close-btn" onclick="closeAddpop()">√ó</button>
  <p class="addpop-title">Select Delivery Location</p>
  <div class="addpop-actions">
    <button class="addpop-detect-btn" onclick="fetchAndSetLocation()">Detect Current Location</button>
    <span class="addpop-or-text">or</span>
    <input type="text" class="addpop-search-input" placeholder="Search Location" />
  </div>
</div>


<!-- ==================== CART SIDEBAR SECTION ==================== -->
<div class="cart-sidebar position-fixed top-0 end-0 bg-white shadow" id="cartSidebar">
    <div class="d-flex justify-content-between align-items-center p-3" style="box-shadow: 0 2px 2px rgb(0 0 0 / 25%);position: sticky;top: 0;background-color: white;z-index: 999;">
        <h5 class="fw-bold"> <i class="fa-solid fa-arrow-left me-3" onclick="closeCart()"></i>My Cart</h5>
        <div class="">
            <button class="btn btn-success btn-sm"><i class="fa fa-wallet"></i> <span class="rupee-symbol-sidecart ms-2">‚Çπ</span> 30</button>
        </div>
    </div>

    <div class="p-3 rounded my-3">
        <div class="d-flex justify-content-between align-items-center">
            <div class="gotostore">
                <h6 class="mb-0 fw-semibold" id="business_name"></h6>
                <a href="storedetail.php"><small class="text-success">Go to store</small></a>
            </div>
            <div class="">
                <button class="btn btn-sm delivery-toggle-btn" id="deliveryToggle">
                    <i class="fa fa-clock me-1"></i> Delivery in 30 min
                </button>
            </div>
        </div>

        <div id="deliveryOptions" style="display: none;">
            <div class="mt-3">
                <div class="d-flex align-items-center mb-2">
                    <input type="radio" name="deliveryOption" class="form-check-input me-2" checked>
                    <div class="row w-100 gx-2">
                        <div class="col">
                            <select class="form-select form-select-sm">
                                <option>Tomorrow, 11/24</option>
                                <option>Today, 11/23</option>
                            </select>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-sm">
                                <option>10:00 AM - 1:00 PM</option>
                                <option>1:00 PM - 4:00 PM</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-check mb-3">
                    <input type="radio" name="deliveryOption" class="form-check-input me-2" id="expressOption">
                    <label for="expressOption" class="form-check-label fw-semibold">
                        Get order in 20 min for ‚Çπ5000
                    </label>
                </div>
                <div class="text-center">
                    <span class="text-muted d-block mb-2">or</span>
                    <button class="btn btn-success w-100" id="expressBtn">
                        <i class="fa fa-bolt me-1"></i> Express Delivery in 20 mins
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="cartItemsWrapper">
        <!-- Cart items will be loaded dynamically -->
    </div>

    <div class="my-3 p-3">
        <div class="xyz-info-box">
            <div class="d-flex align-items-center mb-2">
                <img src="images/demo.png" alt="Icon">
                <div class="ms-3 w-100">
                    <div>Add item worth ‚Çπ<b>5000</b> to get free cook<i class="fa fa-angle-right" style="position: absolute; right: 42px;color:#4caf50;"></i></div>
                    <div class="xyz-progress mt-1">
                        <div class="xyz-progress-bar" style="width: 40%"></div>
                    </div>
                </div>
            </div>
            <br>
            <div class="xyz-clickable-div" data-state="default" onclick="changeText(this)">
                <div>Add item worth ‚Çπ<b>60</b> more to get free delivery<i class="fa fa-angle-right" style="position: absolute; right: 42px;color:#4caf50;"></i></div>
                <div class="xyz-progress mt-1">
                    <div class="xyz-progress-bar" style="width: 80%"></div>
                </div>
            </div>
            <div class="xyz-right-text">*Progress Bar will reset in next order</div>
        </div>
    </div>

    <div class="mb-3 px-2" id="couponsxyz">
        <div class="">
            <h2 class="" id="">
                <button class="couponbutton" type="button" onclick="showModal()">
                    <i class="fa-solid fa-badge-percent"></i>View Coupons & Offers
                    <i class="fa fa-angle-right" style="position: absolute; right: 42px;color:red;"></i>
                </button>
            </h2>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded mb-3 wallet-box p-3">
        <div>
            <span id="walletText"><i class="fa fa-wallet me-1"></i> Kwiklly Points</span>
        </div>
        <button class="btn btn-outline-success btn-sm" id="walletBtn">Use ‚Çπ5</button>
    </div>

    <div class="d-flex align-items-center p-3">
        <h6 class="fw-bold mb-0">Bill Summary</h6>
        <button class="toggle-bill-btn" id="toggleBillBtn"><i class="fa fa-chevron-down"></i></button>
    </div>

    <div class="pt-2 mt-2 p-3" id="billSummary" style="display: none;">
        <ul class="list-unstyled small">
            <li class="d-flex justify-content-between">
                <span>Item charge</span><span>‚Çπ380 <s class="text-muted">‚Çπ332</s></span>
            </li>
            <li class="d-flex justify-content-between">
                <span>Delivery Charges</span><span>‚Çπ20</span>
            </li>
            <li class="d-flex justify-content-between">
                <span>Coupon Discount</span><span class="text-success">- ‚Çπ40</span>
            </li>
            <li class="d-flex justify-content-between">
                <span>Wallet Discount</span><span class="text-success">- ‚Çπ5</span>
            </li>
        </ul>
    </div>

    <div class="delivery-card">
        <div class="delivery-info">
            <div class="details">
                <div class="name">Proudly sponsored by</div>
            </div>
        </div>
        <div class="company"><span style="color:green;">BLUE</span><span style="color:#0047ab;"> DART</span></div>
    </div>

    <div class="grand-total-box p-3">
        <h6>Total charge</h6>
        <div class="total-row">
            <div class="price-wrapper">
                <div class="prices">
                    <del>‚Çπ400</del>
                    <strong>‚Çπ347</strong>
                </div>
                <div class="saved-tag">Saved ‚Çπ53</div>
            </div>
        </div>
    </div>

    <div class="grand-total-box p-3">
        <h3>Grand Total</h3>
        <div class="total-row">
            <div class="price-wrapper">
                <div class="prices">
                    <del>‚Çπ400</del>
                    <strong>‚Çπ347</strong>
                </div>
                <div class="saved-tag">Saved ‚Çπ53</div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        @auth
        <div class="delivery-section">
            <div class="delivery-left">
                <i class="fas fa-home"></i>
                <div class="delivery-text">
                    <div class="label">Delivering to</div>
                    <div id="selectedAddressText">Select an address</div>
                </div>
            </div>
            <div class="change-link" onclick="openSidebar()">Change</div>
        </div>
        @endauth
        <div class="proceed-btn">Proceed to Pay ‚Çπ347</div>
    </div>
</div>

<!-- ==================== ADDRESS SIDEBAR SECTION ==================== -->
<div class="sidebar" id="addressSidebar">
    <div class="sidebar-header">
        <i class="fa-solid fa-arrow-left" onclick="closeSidebar()"></i>Select Address
    </div>

    <div class="add-new-address" onclick="openPataSidebar()">Add new address</div>

    <div class="address-section pataoverflow">
        <div class="section-title">Your Saved Address</div>

        <div class="address-card selected">
            <div class="address-left">
                <img src="https://cdn-icons-png.flaticon.com/128/69/69524.png" alt="Home" class="icon">
                <div>
                    <strong></strong>
                    <p></p>
                </div>
            </div>
            <div class="address-right">
                <span class="check">&#x2714;</span>
                <div class="dropdown-wrapper">
                    <span class="options" onclick="toggleDropdown(this)">&#8942;</span>
                    <div class="dropdown-menu">
                        <div onclick="editAddress()">Edit</div>
                        <div onclick="deleteAddress(this)">Delete</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== ADD ADDRESS SIDEBAR SECTION ==================== -->
<div class="pata-sidebar-overlay" id="pataSidebar">
    <div class="pata-sidebar">
        <div class="pata-sidebar-header">
            <span class="pata-back-btn" onclick="closePataSidebar()"><i class="fa-solid fa-arrow-left"></i></span>
            <h5 class="mb-0">New Address</h5>
        </div>

        <div class="p-3 pataoverflow">
            <div class="pata-location-title">Your Location</div>
            <div class="pata-location-desc">
                Cisf ground, gali no 2, near metro station gate no 3, saket, Delhi
            </div>

            <div class="d-flex justify-content-between pata-tag-buttons mb-3">
                <button type="button" id="pataHomeBtn" class="pata-home active">üè† Home</button>
                <button type="button" id="pataWorkBtn" class="pata-work">üè¢ Work</button>
            </div>

            <form id="addressForm">
                <input type="hidden" name="type" id="addressType" value="home">
                <div class="pata-input"><input type="text" name="area" placeholder="Area / Sector / Locality*" class="form-control" required></div>
                <div class="pata-input"><input type="text" name="flat" placeholder="Flat / Building no*" class="form-control" required></div>
                <div class="pata-input"><input type="text" name="landmark" placeholder="Landmark (optional)" class="form-control"></div>
                <div class="pata-input"><input type="text" name="pincode" placeholder="Pincode*" class="form-control" required></div>
                <div class="pata-input"><input type="text" name="name" placeholder="Name*" class="form-control" required></div>
                <div class="pata-input"><input type="text" name="phone" placeholder="Phone Number*" class="form-control" required></div>
                <div class="pata-input"><input type="text" name="alt_phone" placeholder="Alternate Phone Number (optional)" class="form-control"></div>
                <button type="submit" class="pata-save-btn mt-3 w-100">Save Address</button>
            </form>
        </div>
    </div>
</div>

<!-- ==================== MOBILE CART SIDEBAR SECTION ==================== -->
<div class="cart-sidebar position-fixed top-0 end-0 bg-white shadow" id="cartSidebar2">
    <!-- Similar structure to desktop cart sidebar -->
    <!-- ... -->
</div>

<!-- ==================== COUPON MODAL SECTION ==================== -->
<div class="xyz-modal-overlay" id="couponModalxyz">
    <div class="xyz-modal">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><b>Coupons</b></h5>
            <button class="xyz-close" onclick="hideModal()">&times;</button>
        </div>

        <div class="xyz-coupon-row row m-2">
            <div class="col-6">
                <h6><strong>20% OFF</strong></h6>
                <div style="color: green;">MAX ‚Çπ200</div>
                <small>Holi Week Discount</small>
            </div>
            <div class="col-6 text-end">
                <img src="images/klogo.png" alt="logo" class="xyz-coupon-logo">
                <div><small>COUPON EXPIRES 23/05</small></div>
            </div>
        </div>

        <!-- Repeat coupon rows as needed -->
    </div>
</div>

<!-- ==================== BOTTOM NAVIGATION (MOBILE) ==================== -->
<div class="bottom-nav d-flex justify-content-around d-md-none">
    <a href="{{url('/')}}" class="nav-item nav-link">
        <img src="{{ asset('public/assets/website/images/footlogo.png')}}" alt="" style="height:25px; margin-bottom:6px;">&nbsp;Kwiklly&nbsp;
    </a>
    <a href="department.php" class="nav-item nav-link">
        <img src="{{ asset('public/assets/website/images/departmenticon.png')}}" alt="" style="height:25px; margin-bottom:6px;">Department
    </a>
    <a href="store.php" class="nav-item nav-link">
        <img src="{{ asset('public/assets/website/images/storeicon.png')}}" alt="" style="height:25px; margin-bottom:6px;"> &nbsp;&nbsp;Store&nbsp;&nbsp;
    </a>
    <a href="login.php" class="nav-item nav-link">
        <img src="{{ asset('public/assets/website/images/joinicon.png')}}" alt="" style="height:25px; margin-bottom:6px;"> Join&nbsp;Us
    </a>
</div>

<!-- ==================== JAVASCRIPT SECTION ==================== -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Modal Functions
    function showModal() { document.getElementById('couponModalxyz').style.display = 'flex'; }
    function hideModal() { document.getElementById('couponModalxyz').style.display = 'none'; }

    // Address Form Handling
    document.addEventListener("DOMContentLoaded", function () {
        const homeBtn = document.getElementById("pataHomeBtn");
        const workBtn = document.getElementById("pataWorkBtn");
        const addressType = document.getElementById("addressType");

        homeBtn.addEventListener("click", function () {
            homeBtn.classList.add("active");
            workBtn.classList.remove("active");
            addressType.value = "home";
        });

        workBtn.addEventListener("click", function () {
            workBtn.classList.add("active");
            homeBtn.classList.remove("active");
            addressType.value = "work";
        });

        document.getElementById('addressForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch("{{ route('address.store') }}", {
                method: 'POST',
                headers: { 'X-CSRF-TOKEN': '{{ csrf_token() }}' },
                body: formData
            })
            .then(res => res.ok ? res.json() : res.text().then(text => { throw new Error(text) }))
            .then(data => {
                alert(data.message);
                closePataSidebar();
                openSidebar();
            })
            .catch(err => {
                console.error('Submission error:', err);
                alert('Something went wrong!');
            });
        });
    });

    // Cart Functions
    function openCart() {
        document.getElementById("cartSidebar").classList.add("show");
        document.getElementById("overlay").classList.add("active");
    }
    function closeCart() {
        document.getElementById("cartSidebar").classList.remove("show");
        document.getElementById("overlay").classList.remove("active");
    }

    // Location Popup Functions

    // Google Maps API Key (replace with yours)
    const GOOGLE_MAPS_API_KEY = "{{ env('GOOGLE_MAPS_API_KEY') }}";

    // On DOM ready
    window.onload = function () {
        const popup = document.getElementById("addpopPopup");
        const overlay = document.getElementById("addpopOverlay");
        const locationText = document.getElementById("currentLocation");
        const trigger = document.querySelector(".location-box");

        // Fetch and set current location
        function fetchAndSetLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    try {
                        const response = await fetch(
                            `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${GOOGLE_MAPS_API_KEY}`
                        );
                        const data = await response.json();

                        if (data.status === "OK" && data.results.length > 0) {
                            const address = data.results[0].formatted_address;
                            locationText.innerHTML = `Current Location <br>${address}`;
                        } else {
                            locationText.innerHTML = "Unable to fetch address";
                        }
                    } catch (error) {
                        locationText.innerHTML = "Error fetching location";
                        console.error(error);
                    }
                }, () => {
                    locationText.innerHTML = "Permission denied";
                });
            } else {
                locationText.innerHTML = "Geolocation not supported";
            }
        }

        // Call location fetch on load
        fetchAndSetLocation();

        // Location popup toggle
        function toggleAddpop(e) {
            e.stopPropagation();
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                popup.classList.add("addpop-mobile-active");
            } else {
                const rect = trigger.getBoundingClientRect();
                popup.style.left = rect.left + "px";
                popup.style.top = rect.bottom + window.scrollY + "px";
                popup.classList.add("addpop-desktop-active");
                overlay.classList.add("addpop-visible");
            }

            document.body.style.overflow = 'hidden';
        }

        // Close popup
        function closeAddpop() {
            popup.classList.remove("addpop-mobile-active", "addpop-desktop-active");
            overlay.classList.remove("addpop-visible");
            document.body.style.overflow = 'auto';
        }

        // Make globally accessible (for inline HTML `onclick`)
        window.toggleAddpop = toggleAddpop;
        window.closeAddpop = closeAddpop;
    };



    // Address Sidebar Functions
    function openSidebar() {
        document.getElementById("addressSidebar").classList.add("open");
        fetch("{{ route('address.list') }}", {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRF-TOKEN': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            const container = document.querySelector(".address-section");
            container.innerHTML = `<div class="section-title">Your Saved Address</div>`;

            if (data.length === 0) {
                container.innerHTML += `<p class="text-muted">No address found.</p>`;
                return;
            }

            data.forEach(item => {
                const icon = item.type === 'home'
                    ? 'https://cdn-icons-png.flaticon.com/128/69/69524.png'
                    : 'https://cdn-icons-png.flaticon.com/128/609/609803.png';

                container.innerHTML += `
                <div class="address-card" onclick='selectAddress(this)'
                    data-address="${item.flat}, ${item.area}, ${item.landmark ?? ''}, ${item.pincode}"
                    data-name="${item.name}">
                    <div class="address-left">
                        <img src="${icon}" alt="${item.type}" class="icon">
                        <div>
                            <strong>${capitalize(item.type)}</strong>
                            <p>${item.name}, ${item.flat}, ${item.area}, ${item.landmark ?? ''}, ${item.pincode}</p>
                        </div>
                    </div>
                    <div class="address-right">
                        <span class="check">&#x2714;</span>
                        <div class="dropdown-wrapper">
                            <span class="options" onclick="toggleDropdown(this)">&#8942;</span>
                            <div class="dropdown-menu">
                                <div onclick="editAddress(${item.id})">Edit</div>
                                <div onclick="deleteAddress(${item.id})">Delete</div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });
        })
        .catch(err => console.error("Error loading addresses:", err));
    }

    function closeSidebar() { document.getElementById("addressSidebar").classList.remove("open"); }

    function selectAddress(el) {
        document.querySelectorAll(".address-card").forEach(card => card.classList.remove("selected"));
        el.classList.add("selected");
        const address = el.getAttribute("data-address");
        const name = el.getAttribute("data-name");
        document.getElementById("selectedAddressText").innerText = `${name}, ${address}`;
        sessionStorage.setItem("selectedAddress", JSON.stringify({ name, address }));
        closeSidebar();
    }

    function capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1); }

    // Cart AJAX Handling
    $(document).ready(function () {
        // Initial cart load
        $.get("{{ route('cart.data') }}", function (res) {
            $('#cart-count').text(res.count);
            loadSideCartItems(res.cart);
        });

        // ADD to cart
        $(document).on('click', '.add-btn', function () {
            let productId = $(this).data('product-id');
            let variantId = $(this).data('variant-id');
            if (!variantId) return;

            let parent = $(this).closest('.qty-box');
            let key = productId + '_' + variantId;

            $.ajax({
                url: "{{ route('cart.add') }}",
                type: "POST",
                data: {
                    _token: "{{ csrf_token() }}",
                    product_id: productId,
                    variant_id: variantId,
                    quantity: 1
                },
                success: function (res) {
                    $('#cart-count').text(res.count);
                    loadSideCartItems(res.cart);
                    let qtyContainer = `
                        <div class="qty-container">
                            <button class="qty-btn minus decrement-btn" data-key="${key}">‚àí</button>
                            <input type="text" class="qty-input quantity-input" value="1" readonly>
                            <button class="qty-btn plus increment-btn" data-key="${key}">+</button>
                        </div>
                    `;
                    parent.html(qtyContainer);
                    openCart();
                }
            });
        });

        // INCREMENT quantity
        $(document).on('click', '.increment-btn', function () {
            let key = $(this).data('key');
            $.post("{{ route('cart.increment') }}", {
                _token: "{{ csrf_token() }}",
                key: key
            }, function (res) {
                $('#cart-count').text(res.count);
                loadSideCartItems(res.cart);
                let updatedQty = null;
                $.each(res.cart, function (businessName, items) {
                    if (items[key]) updatedQty = items[key].quantity;
                });
                if (updatedQty !== null) {
                    $(`[data-key="${key}"]`).find('.quantity-input').val(updatedQty);
                }
            });
        });

        // DECREMENT quantity
        $(document).on('click', '.decrement-btn', function () {
            let key = $(this).data('key');
            $.post("{{ route('cart.decrement') }}", {
                _token: "{{ csrf_token() }}",
                key: key
            }, function (res) {
                $('#cart-count').text(res.count);
                loadSideCartItems(res.cart);
                let productId = key.split('_')[0];
                let variantId = key.split('_')[1];
                let productQtyBox = $(`.qty-box[data-product-id="${productId}"][data-variant-id="${variantId}"]`);

                if (!res.cart || !Object.values(res.cart).some(group => group[key])) {
                    productQtyBox.html(`
                        <button class="add-btn" data-product-id="${productId}" data-variant-id="${variantId}">
                            Add
                            <img src="{{ asset('public/assets/website/images/cart.svg') }}" class="ms-2">
                        </button>
                    `);
                } else {
                    $(`[data-key="${key}"] .quantity-input`).val(
                        Object.values(res.cart).find(group => group[key])[key].quantity
                    );
                }
            });
        });

        // Proceed to Checkout
        $('.proceed-btn').on('click', function () {
            $.ajax({
                url: "{{ route('check.auth.status') }}",
                method: "GET",
                success: function (res) {
                    if (res.logged_in) {
                        window.location.href = "{{ route('checkout.page') }}";
                    } else {
                        window.location.href = "{{ route('login') }}";
                    }
                }
            });
        });
    });

    // Render cart items in sidebar
    function loadSideCartItems(cartGroups) {
        let html = '';
        let total = 0;

        if (cartGroups && Object.keys(cartGroups).length > 0) {
            $.each(cartGroups, function (businessName, items) {
                html += `<div class="cart-business-group mb-3">
                    <h6 class="mb-1">${businessName}</h6>
                    <a href="#" class="small text-primary mb-2 d-block">Go to store</a>
                `;

                $.each(items, function (key, item) {
                    let price = parseFloat(item.price);
                    let quantity = parseInt(item.quantity);
                    let originalPrice = item.original_price || price;
                    let subtotal = price * quantity;
                    total += subtotal;

                    html += `
                        <div class="cart-item d-flex align-items-center justify-content-between border-bottom py-2 p-3">
                            <div class="d-flex align-items-center totalimg">
                                <img src="${item.image}" alt="${item.title}" style="width:50px;">
                                <div class="mx-3">
                                    <p class="mb-0">${item.title}</p>
                                    <small class="text-success">
                                        ‚Çπ${price} ${price < originalPrice ? `<s class="text-muted">‚Çπ${originalPrice}</s>` : ''}
                                    </small>
                                </div>
                            </div>
                            <div class="input-group input-group-sm sidecartbutton" style="width: 90px;">
                                <button class="btn btn-danger decrement-btn" data-key="${key}">-</button>
                                <input type="text" class="form-control text-center quantity-input" value="${quantity}" disabled>
                                <button class="btn btn-danger increment-btn" data-key="${key}">+</button>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            });
        } else {
            html = `<p class="text-center">Your cart is empty.</p>`;
        }

        $('#cartItemsWrapper').html(html);
        updateBillSummary(total);
    }

    function updateBillSummary(total) {
        let deliveryCharge = 0;
        let couponDiscount = 0;
        let walletDiscount = 0;
        let grandTotal = total + deliveryCharge - couponDiscount - walletDiscount;

        $('#billSummary').html(`
            <ul class="list-unstyled small">
              <li class="d-flex justify-content-between">
                <span>Item charge</span><span>‚Çπ${total}</span>
              </li>
              <li class="d-flex justify-content-between">
                <span>Delivery Charges</span><span>‚Çπ${deliveryCharge}</span>
              </li>
              <li class="d-flex justify-content-between">
                <span>Coupon Discount</span><span class="text-success">- ‚Çπ${couponDiscount}</span>
              </li>
              <li class="d-flex justify-content-between">
                <span>Wallet Discount</span><span class="text-success">- ‚Çπ${walletDiscount}</span>
              </li>
            </ul>
        `);

        $('.proceed-btn').html(`Proceed to Pay ‚Çπ${grandTotal}`);
        $('.grand-total-box strong').html(`‚Çπ${grandTotal}`);
    }
</script>

</body>
</html>
